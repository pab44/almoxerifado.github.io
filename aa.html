<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sistema Empréstimo — Assinatura</title>
<style>
  :root{--primary:#ff9800;--dark:#111;--muted:#f2f2f2;--card:#fff;}
  *{box-sizing:border-box}body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--muted);color:var(--dark);-webkit-font-smoothing:antialiased;}
  header{background:linear-gradient(90deg,var(--dark),#333);color:var(--card);padding:18px 20px;display:flex;align-items:center;justify-content:space-between;}
  .brand{display:flex;gap:12px;align-items:center}.logo{width:44px;height:44px;border-radius:8px;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#000;font-weight:700;font-size:18px;}
  h1{margin:0;font-size:18px}nav{display:flex;gap:8px}nav button{background:transparent;color:var(--card);border:1px solid rgba(255,255,255,0.12);padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
  main{max-width:980px;margin:18px auto;padding:16px}.card{background:var(--card);border-radius:12px;padding:16px;margin-bottom:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  .row{display:flex;gap:12px;flex-wrap:wrap}label{display:block;font-weight:700;margin-top:8px}input,select,textarea{padding:10px;border-radius:8px;border:1px solid #ddd;width:100%}
  .two{flex:1 1 48%}.one{flex:1 1 100%}button.primary{background:var(--primary);border:none;color:#000;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
  button.ghost{background:transparent;border:1px solid #ddd;color:var(--dark);padding:8px 12px;border-radius:8px;cursor:pointer}table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}.small{font-size:13px;color:#666}.center{display:flex;justify-content:center;align-items:center}
  #signaturePad-emprestimo{width:100%;height:160px;border:3px solid #000;border-radius:10px;background:#fff;touch-action:none}.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  @media (max-width:720px){.two{flex:1 1 100%}header{padding:12px}nav{gap:6px}.logo{width:36px;height:36px}}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">A</div>
    <div>
      <h1>Sistema Empréstimo</h1>
      <div class="small">laranja & preto — mobile friendly</div>
    </div>
  </div>
  <nav>
    <button onclick="showScreen('emprestimo')">Empréstimo</button>
    <button onclick="showScreen('devolucao')">Devolução</button>
    <button onclick="showScreen('assinatura')">Assinatura</button>
    <button onclick="showScreen('estoque')">Estoque</button>
  </nav>
</header>

<main>
  <!-- EMPRESTIMO -->
  <section id="screen-emprestimo" class="card">
    <h2>Registrar Empréstimo</h2>
    <div class="row">
      <div class="two">
        <label>Nome da Pessoa</label>
        <input id="emprestimo-nome" placeholder="Ex: João Silva">
      </div>
      <div class="two">
        <label>Ferramenta</label>
        <input id="emprestimo-ferramenta" placeholder="Ex: Furadeira">
      </div>
      <div class="two">
        <label>Quantidade</label>
        <input id="emprestimo-quantidade" type="number" min="1" value="1">
      </div>
      <div class="two">
        <label>Data</label>
        <input id="emprestimo-data" type="date">
      </div>
    </div>

    <div style="margin-top:12px" class="row">
      <div class="one">
        <label>Observações</label>
        <textarea id="emprestimo-observacao" rows="2" placeholder="Opcional"></textarea>
      </div>
    </div>

    <!-- ASSINATURA DENTRO DO EMPRÉSTIMO -->
    <div style="margin-top:16px" class="card">
      <h3>Assinatura Digital</h3>
      <div class="small">Toque ou arraste para assinar.</div>
      <canvas id="signaturePad-emprestimo" style="width:100%;height:160px;border:3px solid #000;border-radius:10px;background:#fff;touch-action:none"></canvas>
      <div class="controls">
        <button class="ghost" onclick="limparAssinaturaEmprestimo()">Limpar</button>
        <button class="primary" onclick="registrarEmprestimoComAssinatura()">Registrar Empréstimo</button>
      </div>
    </div>

    <div id="emprestimo-list" style="margin-top:16px"></div>
  </section>

  <!-- DEVOLUCAO -->
  <section id="screen-devolucao" class="card" style="display:none">
    <h2>Registrar Devolução</h2>
    <div class="row">
      <div class="two">
        <label>Nome da Pessoa</label>
        <input id="devolucao-nome" placeholder="Ex: João Silva">
      </div>
      <div class="two">
        <label>Ferramenta</label>
        <input id="devolucao-ferramenta" placeholder="Ex: Furadeira">
      </div>
      <div class="two">
        <label>Quantidade</label>
        <input id="devolucao-quantidade" type="number" min="1" value="1">
      </div>
      <div class="two">
        <label>Data</label>
        <input id="devolucao-data" type="date">
      </div>
    </div>

    <div style="margin-top:12px" class="row">
      <div class="one center">
        <button class="primary" onclick="registrarDevolucao()">Registrar Devolução</button>
      </div>
    </div>

    <div id="devolucao-list" style="margin-top:16px"></div>
  </section>

  <!-- ESTOQUE -->
  <section id="screen-estoque" class="card" style="display:none">
    <h2>Controle de Estoque</h2>
    <div class="row">
      <div class="two">
        <label>Adicionar/Atualizar item</label>
        <input id="estoque-nome" placeholder="Nome da ferramenta">
        <label style="margin-top:8px">Quantidade</label>
        <input id="estoque-quant" type="number" min="0" value="0">
        <div style="margin-top:8px">
          <button class="primary" onclick="atualizarEstoque()">Salvar item</button>
          <button class="ghost" onclick="limparEstoqueForm()">Limpar</button>
        </div>
      </div>

      <div class="two">
        <label>Lista de estoque</label>
        <div id="lista-estoque" style="max-height:320px;overflow:auto"></div>
      </div>
    </div>
  </section>
</main>

<script>
const LS_KEYS = {
  estoque: 'sist_estoque_v1',
  registros: 'sist_registros_v1',
  ultimaAssinatura: 'sist_ultima_assin_v1'
};

function loadJSON(key, fallback){
  try {
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : fallback;
  } catch(e){ return fallback; }
}
function saveJSON(key, obj){
  localStorage.setItem(key, JSON.stringify(obj));
}

let estoque = loadJSON(LS_KEYS.estoque, {
  "Furadeira": 3,
  "Parafusadeira": 5,
  "Martelo": 10
});
let registros = loadJSON(LS_KEYS.registros, []);

function showScreen(name){
  document.querySelectorAll('main section').forEach(s => s.style.display='none');
  const el = document.getElementById('screen-'+name);
  if(!el) return;
  el.style.display='block';
  renderAll();
}
showScreen('emprestimo');

function renderEstoque(){
  const container = document.getElementById('lista-estoque');
  if(!container) return;
  let html = '<table><thead><tr><th>Ferramenta</th><th>Quantidade</th><th></th></tr></thead><tbody>';
  Object.keys(estoque).sort().forEach(k=>{
    html += `<tr><td>${escapeHtml(k)}</td><td>${estoque[k]}</td><td><button class="ghost" onclick="removerItemEstoque('${escapeHtml(k)}')">Remover</button></td></tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}
function renderRegistros(){
  const el = document.getElementById('emprestimo-list');
  const elD = document.getElementById('devolucao-list');
  if(el) {
    let html = '<h3>Últimos empréstimos</h3>';
    const ultimos = registros.filter(r=>r.tipo==='emprestimo').slice().reverse().slice(0,6);
    if(!ultimos.length) html += '<div class="small">Nenhum</div>';
    else {
      html += '<table><thead><tr><th>Nome</th><th>Ferramenta</th><th>Qtd</th><th>Data</th><th>Assinatura</th></tr></thead><tbody>';
      ultimos.forEach(r=>{
        html += `<tr><td>${escapeHtml(r.nome)}</td><td>${escapeHtml(r.ferramenta)}</td><td>${r.quant}</td><td>${r.data}</td><td>${r.assinatura ? '✓' : ''}</td></tr>`;
      });
      html += '</tbody></table>';
    }
    el.innerHTML = html;
  }
  if(elD){
    let html = '<h3>Últimas devoluções</h3>';
    const ultimos = registros.filter(r=>r.tipo==='devolucao').slice().reverse().slice(0,6);
    if(!ultimos.length) html += '<div class="small">Nenhum</div>';
    else {
      html += '<table><thead><tr><th>Nome</th><th>Ferramenta</th><th>Qtd</th><th>Data</th></tr></thead><tbody>';
      ultimos.forEach(r=>{
        html += `<tr><td>${escapeHtml(r.nome)}</td><td>${escapeHtml(r.ferramenta)}</td><td>${r.quant}</td><td>${r.data}</td></tr>`;
      });
      html += '</tbody></table>';
    }
    elD.innerHTML = html;
  }
}
function renderAll(){
  renderEstoque();
  renderRegistros();
}

function registrarEmprestimoComAssinatura(){
  const nome = document.getElementById('emprestimo-nome').value.trim();
  const ferramenta = document.getElementById('emprestimo-ferramenta').value.trim();
  const quant = Number(document.getElementById('emprestimo-quantidade').value) || 1;
  const data = document.getElementById('emprestimo-data').value || hoje();
  if(!nome || !ferramenta) return alert('Preencha nome e ferramenta.');

  const canvasEmprestimo = document.getElementById('signaturePad-emprestimo');
  const w = canvasEmprestimo.offsetWidth;
  const h = canvasEmprestimo.offsetHeight;
  const tmp = document.createElement('canvas');
  tmp.width = w; tmp.height = h;
  const tctx = tmp.getContext('2d');
  tctx.drawImage(canvasEmprestimo, 0, 0, w, h);
  const assinatura = tmp.toDataURL('image/png');

  if(!estoque[ferramenta]) estoque[ferramenta] = 0;
  estoque[ferramenta] = Math.max(0, estoque[ferramenta] - quant);

  const registro = { 
    tipo:'emprestimo', 
    nome, 
    ferramenta, 
    quant, 
    data, 
    observacao: document.getElementById('emprestimo-observacao').value || '', 
    assinatura: assinatura, 
    createdAt: new Date().toISOString() 
  };
  registros.push(registro);
  saveJSON(LS_KEYS.registros, registros);
  saveJSON(LS_KEYS.estoque, estoque);
  alert('Empréstimo registrado!');
  limparFormEmprestimo();
  limparAssinaturaEmprestimo();
}
function registrarDevolucao(){
  const nome = document.getElementById('devolucao-nome').value.trim();
  const ferramenta = document.getElementById('devolucao-ferramenta').value.trim();
  const quant = Number(document.getElementById('devolucao-quantidade').value) || 1;
  const data = document.getElementById('devolucao-data').value || hoje();
  if(!nome || !ferramenta) return alert('Preencha nome e ferramenta.');

  if(!estoque[ferramenta]) estoque[ferramenta] = 0;
  estoque[ferramenta] = estoque[ferramenta] + quant;

  const registro = { tipo:'devolucao', nome, ferramenta, quant, data, createdAt: new Date().toISOString() };
  registros.push(registro);
  saveJSON(LS_KEYS.registros, registros);
  saveJSON(LS_KEYS.estoque, estoque);
  alert('Devolução registrada!');
  limparFormDevolucao();
  renderAll();
}

function atualizarEstoque(){
  const nome = document.getElementById('estoque-nome').value.trim();
  const quant = Number(document.getElementById('estoque-quant').value) || 0;
  if(!nome) return alert('Preencha o nome da ferramenta.');
  estoque[nome] = quant;
  saveJSON(LS_KEYS.estoque, estoque);
  limparEstoqueForm();
  renderAll();
}
function removerItemEstoque(nome){
  if(!confirm('Remover '+nome+' do estoque?')) return;
  delete estoque[nome];
  saveJSON(LS_KEYS.estoque, estoque);
  renderAll();
}
function limparEstoqueForm(){
  document.getElementById('estoque-nome').value = '';
  document.getElementById('estoque-quant').value = 0;
}

function limparFormEmprestimo(){
  document.getElementById('emprestimo-nome').value='';
  document.getElementById('emprestimo-ferramenta').value='';
  document.getElementById('emprestimo-quantidade').value=1;
  document.getElementById('emprestimo-data').value = hoje();
  document.getElementById('emprestimo-observacao').value='';
}
function limparFormDevolucao(){
  document.getElementById('devolucao-nome').value='';
  document.getElementById('devolucao-ferramenta').value='';
  document.getElementById('devolucao-quantidade').value=1;
  document.getElementById('devolucao-data').value = hoje();
}
function limparAssinaturaEmprestimo(){
  const canvasEmprestimo = document.getElementById('signaturePad-emprestimo');
  const ctxEmprestimo = canvasEmprestimo.getContext('2d');
  ctxEmprestimo.clearRect(0, 0, canvasEmprestimo.width, canvasEmprestimo.height);
}

function hoje(){ return new Date().toISOString().substr(0,10); }
document.querySelectorAll('input[type="date"]').forEach(i=>i.value = hoje());

// Canvas assinatura
const canvasEmprestimo = document.getElementById('signaturePad-emprestimo');
const ctxEmprestimo = canvasEmprestimo.getContext('2d');
canvasEmprestimo.width = 800;
canvasEmprestimo.height = 160;
ctxEmprestimo.lineWidth = 2;
ctxEmprestimo.strokeStyle = '#000';
ctxEmprestimo.lineCap = 'round';

let drawing = false;
let lastX = 0;
let lastY = 0;

canvasEmprestimo.addEventListener('mousedown', (e) => {
  drawing = true;
  const rect = canvasEmprestimo.getBoundingClientRect();
  lastX = e.clientX - rect.left;
  lastY = e.clientY - rect.top;
});
canvasEmprestimo.addEventListener('mousemove', (e) => {
  if (!drawing) return;
  const rect = canvasEmprestimo.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  ctxEmprestimo.beginPath();
  ctxEmprestimo.moveTo(lastX, lastY);
  ctxEmprestimo.lineTo(x, y);
  ctxEmprestimo.stroke();
  lastX = x;
  lastY = y;
});
canvasEmprestimo.addEventListener('mouseup', () => drawing = false);
canvasEmprestimo.addEventListener('mouseout', () => drawing = false);

canvasEmprestimo.addEventListener('touchstart', (e) => {
  e.preventDefault();
  drawing = true;
  const rect = canvasEmprestimo.getBoundingClientRect();
  const t = e.touches[0];
  lastX = t.clientX - rect.left;
  lastY = t.clientY - rect.top;
}, { passive: false });
canvasEmprestimo.addEventListener('touchmove', (e) => {
  e.preventDefault();
  if (!drawing) return;
  const rect = canvasEmprestimo.getBoundingClientRect();
  const t = e.touches[0];
  const x = t.clientX - rect.left;
  const y = t.clientY - rect.top;
  ctxEmprestimo.beginPath();
  ctxEmprestimo.moveTo(lastX, lastY);
  ctxEmprestimo.lineTo(x, y);
  ctxEmprestimo.stroke();
  lastX = x;
  lastY = y;
}, { passive: false });
canvasEmprestimo.addEventListener('touchend', () => drawing = false, { passive: false });

function escapeHtml(s){
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

renderAll();
</script>
</body>
</html>
